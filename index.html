<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabian Nights Photo Booth</title>
    <link rel="stylesheet" href="styles.css">
    <style>

        /* Custom font for theme - using system fallback to work offline */
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-image: url('vecteezy_man-riding-camel-in-desert-night-with-mosque-and-moon_7494341.webp');
            background-size: cover;
        }
        .themed-title {
            font-family: 'Cinzel Decorative', cursive;
        }
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
        .loader {
            border: 18px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #8B5CF6;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-start min-h-screen p-4 overflow-x-hidden overflow-y-auto">

    <div class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row items-stretch lg:items-center justify-center gap-6 sm:gap-8">
        
        <div class="w-full lg:w-1/2 flex flex-col items-center gap-3 sm:gap-4">
            <h1 class="themed-title aladin-regular text-4xl sm:text-5xl md:text-6xl text-yellow-300 text-center leading-tight">Arabian Nights</h1>
            <p class="text-xl sm:text-2xl text-white-300 text-center">Photo Booth</p>
            
            <div id="setup-screen" class="w-full max-w-lg p-4 sm:p-6 bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-lg border border-purple-400/30">
                <p class="text-center mb-4">Stand in front of your green screen and click below to begin! Each time you click the photo, a random background will appear </p>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-purple-200 text-center">Select Aspect Ratio</label>
                    <div class="flex items-center justify-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="aspect" value="landscape" id="aspect-landscape" class="accent-purple-500" checked>
                            <span>Landscape (16:9)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="aspect" value="portrait" id="aspect-portrait" class="accent-purple-500">
                            <span>Portrait (9:16)</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-purple-200 text-center">Select Camera</label>
                    <div class="flex items-center justify-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="camera" value="user" id="camera-front" class="accent-purple-500" checked>
                            <span>Front</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="camera" value="environment" id="camera-back" class="accent-purple-500">
                            <span>Back</span>
                        </label>
                    </div>
                </div>
                <button id="start-camera" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform transform hover:scale-105 shadow-lg">
                    Start Camera
                </button>
            </div>

            <div id="booth-active" class="hidden w-full max-w-2xl relative">
                 <button id="back-to-setup" class="absolute top-3 left-3 z-10 bg-black hover:bg-black text-white px-3 py-2 rounded-5 border border-white/20 shadow">
                     Back
                 </button>
                 <video id="video" autoplay playsinline class="rounded-2xl w-full h-auto aspect-video object-cover border-2 border-purple-400/50 shadow-lg"></video>
                 <canvas id="canvas" class="hidden"></canvas>
                 <button id="snap" class="absolute bottom-3 sm:bottom-4 left-1/2 -translate-x-1/2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold h-14 w-14 sm:h-16 sm:w-16 rounded-full text-base sm:text-lg transition-transform transform hover:scale-110 shadow-lg border-4 border-white flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                 </button>
            </div>
        </div>

        <div class="w-full lg:w-1/2 flex flex-col items-center justify-center p-3 sm:p-4 min-h-[300px] sm:min-h-[380px] lg:min-h-[480px]">
            <div id="result-container" class="hidden w-full max-w-2xl flex flex-col items-center gap-3 sm:gap-4">
                <h2 class="text-xl sm:text-2xl font-bold text-yellow-300 text-center">Your Magical Portrait!</h2>
                <img id="photo" alt="Your final photo" loading="lazy" class="rounded-2xl w-full h-auto aspect-video object-cover border-2 border-yellow-300 shadow-lg"/>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 w-full">
                     <a id="download" href="#" download="arabian-nights-photo.png" class="w-full sm:flex-1 text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 shadow-lg">Download PNG</a>
                     <button id="try-again" class="w-full sm:flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 shadow-lg">Try Again</button>
                </div>
                <div id="portrait-container" class="hidden w-full max-w-sm flex flex-col items-center gap-3">
                    <h3 class="text-lg font-semibold text-yellow-300 text-center">Portrait Preview (9:16)</h3>
                    <img id="photo-portrait" alt="Your portrait photo" loading="lazy" class="rounded-2xl w-full h-auto aspect-[9/16] object-cover border-2 border-yellow-300 shadow-lg"/>
                    <a id="download-portrait" href="#" download="arabian-nights-photo-portrait.png" class="w-full text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 shadow-lg">Download PNG</a>
                    <button id="try-again-portrait" class="w-full sm:flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 shadow-lg">Try Again</button>
                </div>
            </div>
            <div id="placeholder" class="text-black flex flex-col items-center justify-center text-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 mb-4"><path d="m13 10-2 5 2 5"/><path d="m18 10-2 5 2 5"/><path d="M7 10a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M12 10a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M2 10a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M7 20a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M12 20a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M2 20a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M7 15a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M12 15a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M2 15a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/></svg>
                <p>Your final image will appear here.</p>
            </div>
            <div id="loading" class="hidden flex-col items-center gap-3 sm:gap-4">
                <div class="loader"></div>
                <p class="text-lg text-purple-300">Creating magic...</p>
            </div>
        </div>

    </div>

    <footer class="w-full mt-auto bg-footer-translucent text-gray-400 text-xs sm:text-sm border-t border-gray-700/50">
        <div class="max-w-5xl mx-auto px-4 py-6 flex flex-col gap-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <p class="leading-relaxed">
                    Step into a magical world and create themed portraits. Replace your green screen with iconic Arabian Nights backdrops.
                </p>
                <nav class="flex flex-wrap items-center gap-x-4 gap-y-2">
                    <a href="about.html" class="hover:text-gray-200 transition-colors">About </a>
                    <a href="privacy.html" class="hover:text-gray-200 transition-colors">Privacy </a>
                    <a href="contact.html" class="hover:text-gray-200 transition-colors">Contact </a>
                </nav>
            </div>
            <div class="text-[11px] sm:text-xs opacity-80">
                <span>Created for DJ UNICODE CELESTIA '25<br></span>
                <span>Â© <span id="year"></span> Arabian Nights Photo Booth. All rights reserved.<br></span>
                <span>By Vandit Mehta</span>
            </div>
        </div>
    </footer>

    <script>
        // DOM Elements
        const startButton = document.getElementById('start-camera');
        const setupScreen = document.getElementById('setup-screen');
        const boothActive = document.getElementById('booth-active');
        const resultContainer = document.getElementById('result-container');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const snap = document.getElementById('snap');
        const downloadLink = document.getElementById('download');
        const tryAgainButton = document.getElementById('try-again');
        const tryAgainPortraitButton = document.getElementById('try-again-portrait');
        const aspectLandscape = document.getElementById('aspect-landscape');
        const aspectPortrait = document.getElementById('aspect-portrait');
        const backToSetup = document.getElementById('back-to-setup');
        const portraitContainer = document.getElementById('portrait-container');
        const photoPortrait = document.getElementById('photo-portrait');
        const downloadPortrait = document.getElementById('download-portrait');

        // Aspect state
        let selectedAspect = 'landscape'; // 'landscape' | 'portrait'
        function getAspectRatio() {
            return selectedAspect === 'landscape' ? 16/9 : 9/16;
        }

        // Background Images
        const backgroundsLandscape = [
            'palace 5.webp',
            'tiger 1.webp',
            'lamp1.webp',
            'palace 2.webp',
            'palace 4.webp',
            'palace.webp',
            'palace3.webp',
            'genie 3.webp',
            'genie 2.webp',
            'genie 1.webp',
            'desert 1.webp',
            'abu.webp',
            'all 3.webp',
            'all3.webp',
            'arabian nights.webp',
            'carpet 1.webp',
            'carpet and genie.webp'
        ];
        const backgroundsPortrait = [
            'aladin and abu.webp',
            'aladin and genie.webp',
            'scene2.webp',
            'lamp2.webp',
            'genie4.webp',
            'jafar1.webp',
            'liveaction1.webp',
            'carpet and genie.webp',
            'scene1.webp',
            'gettyimages-1430989752-612x612.webp'
        ];
        
        // Start Camera Logic
        startButton.addEventListener('click', async () => {
            selectedAspect = aspectPortrait.checked ? 'portrait' : 'landscape';
            // MODIFIED: Read the selected camera facing mode
            const selectedCamera = document.querySelector('input[name="camera"]:checked').value;

            try {
                const constraints = {
                    video: {
                        // MODIFIED: Use the selected camera
                        facingMode: selectedCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        aspectRatio: { ideal: getAspectRatio() }
                    },
                    audio: false
                };
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (e) {
                    // Fallback for older browsers / devices
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                }
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    setupScreen.classList.add('hidden');
                    boothActive.classList.remove('hidden');
                    // Toggle preview aspect class
                    if (selectedAspect === 'portrait') {
                        // Use a 9:16 container by forcing width smaller than height
                        video.classList.remove('aspect-video');
                        video.classList.add('aspect-[9/16]');
                        // Narrow the live video container for portrait
                        boothActive.classList.remove('max-w-2xl');
                        boothActive.classList.add('max-w-md');
                    } else {
                        video.classList.remove('aspect-[9/16]');
                        video.classList.add('aspect-video');
                        // Widen the live video container for landscape
                        boothActive.classList.remove('max-w-md');
                        boothActive.classList.add('max-w-2xl');
                    }
                };
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                alert("Could not access the webcam. Please make sure it's enabled and not in use by another application.");
            }
        });

        // Back button: stop stream and return to aspect selection
        backToSetup.addEventListener('click', () => {
            const stream = video.srcObject;
            if (stream && typeof stream.getTracks === 'function') {
                stream.getTracks().forEach(t => t.stop());
            }
            video.srcObject = null;
            boothActive.classList.add('hidden');
            resultContainer.classList.add('hidden');
            loading.classList.add('hidden');
            placeholder.classList.remove('hidden');
            setupScreen.classList.remove('hidden');
        });

        // Take Photo Logic
        snap.addEventListener('click', () => {
            // Show loading spinner
            placeholder.classList.add('hidden');
            resultContainer.classList.add('hidden');
            loading.classList.remove('hidden');

            // Set canvas dimensions to match video feed
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the current video frame to the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Process the image after a short delay to allow UI to update
            setTimeout(processImage, 100);
        });
        
        function processImage() {
            const context = canvas.getContext('2d');
            
            // Get the pixel data from the canvas
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Chroma Keying: Loop through every pixel
            for (let i = 0; i < data.length; i += 4) {
                const red = data[i];
                const green = data[i + 1];
                const blue = data[i + 2];
                
                // Simple but effective green screen check
                // This checks if green is the dominant color and is bright enough
                if (green > 90 && green > red * 1.3 && green > blue * 1.3) {
                    // Set alpha to 0 to make the pixel transparent
                    data[i + 3] = 0;
                }
            }
            
            // Put the modified pixel data back
            context.putImageData(imageData, 0, 0);

            // Crop to selected aspect before compositing
            cropToAspectAndCompose();
        }

        function cropToAspectAndCompose() {
            const desiredAspect = getAspectRatio();
            const srcW = canvas.width;
            const srcH = canvas.height;
            const currentAspect = srcW / srcH;

            let drawW = srcW;
            let drawH = srcH;
            let sx = 0;
            let sy = 0;

            if (Math.abs(currentAspect - desiredAspect) > 0.001) {
                if (currentAspect > desiredAspect) {
                    // Too wide -> crop sides
                    drawW = Math.round(srcH * desiredAspect);
                    sx = Math.floor((srcW - drawW) / 2);
                } else {
                    // Too tall -> crop top/bottom
                    drawH = Math.round(srcW / desiredAspect);
                    sy = Math.floor((srcH - drawH) / 2);
                }
            }

            const tmp = document.createElement('canvas');
            tmp.width = drawW;
            tmp.height = drawH;
            const tctx = tmp.getContext('2d');
            tctx.drawImage(canvas, sx, sy, drawW, drawH, 0, 0, drawW, drawH);

            // Replace main canvas content with cropped content
            canvas.width = drawW;
            canvas.height = drawH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(tmp, 0, 0);

            // Composite the foreground with a random background
            addBackground();
        }

        // Shuffle function
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Track shuffled backgrounds and current index
        let shuffledBackgrounds = [];
        let bgIndex = 0;

        function getNextBackground() {
            if (bgIndex === 0 || bgIndex >= shuffledBackgrounds.length) {
                const pool = selectedAspect === 'portrait' ? backgroundsPortrait : backgroundsLandscape;
                shuffledBackgrounds = pool.slice();
                shuffle(shuffledBackgrounds);
                bgIndex = 0;
            }
            let next = shuffledBackgrounds[bgIndex++];
            while ((typeof next !== 'string') || next.trim() === '') {
                if (bgIndex >= shuffledBackgrounds.length) {
                    shuffledBackgrounds = backgrounds.slice();
                    shuffle(shuffledBackgrounds);
                    bgIndex = 0;
                }
                next = shuffledBackgrounds[bgIndex++];
            }
            return next;
        }

        function addBackground() {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            const randomBgSrc = getNextBackground();
            const background = new Image();
            const isRemote = /^https?:\/\//i.test(randomBgSrc);
            if (isRemote) {
                background.crossOrigin = "anonymous";
            }
            background.src = encodeURI(randomBgSrc);

            background.onload = () => {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;

                tempCtx.drawImage(background, 0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(canvas, 0, 0);

                try {
                    const finalImage = tempCanvas.toDataURL('image/png');
                    photo.src = finalImage;
                    downloadLink.href = finalImage;

                    // If portrait aspect was selected, show dedicated portrait preview/download
                    if (selectedAspect === 'portrait') {
                        portraitContainer.classList.remove('hidden');
                        photoPortrait.src = finalImage;
                        downloadPortrait.href = finalImage;
                        // Hide landscape preview elements
                        photo.classList.add('hidden');
                        downloadLink.classList.add('hidden');
                        // Hide the main Try Again for portrait
                        tryAgainButton.classList.add('hidden');
                    } else {
                        // Show landscape preview and hide portrait block
                        portraitContainer.classList.add('hidden');
                        photo.classList.remove('hidden');
                        downloadLink.classList.remove('hidden');
                        // Show the main Try Again for landscape
                        tryAgainButton.classList.remove('hidden');
                    }

                    loading.classList.add('hidden');
                    resultContainer.classList.remove('hidden');
                    boothActive.classList.add('hidden');
                } catch (e) {
                    alert('Background loaded but cannot be exported due to CORS. Try a different background.');
                    resetBooth();
                }
            };

            background.onerror = () => {
                alert('Failed to load the background image. Please try again.');
                resetBooth();
            };
        }
        
        // Try Again Logic
        tryAgainButton.addEventListener('click', resetBooth);
        tryAgainPortraitButton?.addEventListener('click', resetBooth);

        function resetBooth() {
            resultContainer.classList.add('hidden');
            placeholder.classList.remove('hidden');
            boothActive.classList.remove('hidden');
        }

        // Footer year
        const yearEl = document.getElementById('year');
        if (yearEl) {
            yearEl.textContent = new Date().getFullYear();
        }

    </script>
</body>
</html>

